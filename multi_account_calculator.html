<!-- Frontend modifications for Multi-Account MT5 Trading System -->
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gold Trading Calculator - Multi Account</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Additional styles for multi-account features */
        .auth-container {
            max-width: 400px;
            margin: 20px auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        
        .account-selector {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 6px;
            background: #fff;
        }
        
        .account-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #eee;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .account-item:hover {
            background-color: #f0f0f0;
        }
        
        .account-item.active {
            background-color: #e7f3ff;
            border-color: #007cba;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-connected { background-color: #28a745; }
        .status-disconnected { background-color: #dc3545; }
        .status-connecting { background-color: #ffc107; animation: pulse 1s infinite; }
        
        /* Broadcast Mode Styles */
        .broadcast-section {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #ffc107;
            border-radius: 8px;
            background: linear-gradient(135deg, #fff8e1, #fff3c4);
        }
        
        .broadcast-title {
            color: #e65100;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .broadcast-controls {
            margin: 15px 0;
        }
        
        .broadcast-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
        
        .broadcast-status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 6px;
            background: #f8f9fa;
            border-left: 4px solid #007cba;
        }
        
        .super-admin-badge {
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .broadcast-badge {
            background: linear-gradient(45deg, #74b9ff, #0984e3);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .hidden { display: none !important; }
        .error { color: #dc3545; margin: 10px 0; }
        .success { color: #28a745; margin: 10px 0; }
    </style>
</head>
<body>
    <!-- Authentication Section -->
    <div id="authContainer" class="auth-container">
        <h2>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Trading Calculator</h2>
        
        <!-- Login Form -->
        <div id="loginForm">
            <h3>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h3>
            <input type="text" id="loginUsername" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏≠‡∏µ‡πÄ‡∏°‡∏•" required>
            <input type="password" id="loginPassword" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" required>
            <button onclick="login()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            <p><a href="#" onclick="showRegisterForm()">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà</a></p>
        </div>
        
        <!-- Register Form -->
        <div id="registerForm" class="hidden">
            <h3>‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h3>
            <input type="text" id="registerUsername" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ" required>
            <input type="email" id="registerEmail" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" required>
            <input type="password" id="registerPassword" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" required>
            <input type="password" id="confirmPassword" placeholder="‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" required>
            <select id="registerRole">
                <option value="user">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
                <option value="broadcast">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ Broadcast</option>
                <option value="super_admin">Super Admin</option>
            </select>
            <button onclick="register()">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
            <p><a href="#" onclick="showLoginForm()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</a></p>
        </div>
        
        <div id="authMessage" class="error"></div>
    </div>

    <!-- Main Application (hidden until authenticated) -->
    <div id="mainApp" class="hidden">
        
        <!-- User Info and Logout -->
        <div style="text-align: right; padding: 10px; border-bottom: 1px solid #eee;">
            <span id="userInfo"></span>
            <span id="userRoleBadge" class="hidden"></span>
            <button onclick="logout()" style="margin-left: 10px;">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>

        <!-- Broadcast Section (Super Admin Only) -->
        <div id="broadcastSection" class="broadcast-section hidden">
            <h3 class="broadcast-title">
                üì° ‡∏£‡∏∞‡∏ö‡∏ö Broadcast Orders (Super Admin)
            </h3>
            
            <div class="broadcast-controls">
                <div class="broadcast-toggle">
                    <input type="checkbox" id="broadcastMode" onchange="toggleBroadcastMode()">
                    <label for="broadcastMode">üöÄ ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Broadcast Mode</label>
                </div>
                
                <div id="broadcastInfo" class="broadcast-status hidden">
                    <p><strong>üì¢ Broadcast Mode ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</strong></p>
                    <p>‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á ‡∏à‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ role "broadcast"</p>
                    <button onclick="checkBroadcastStatus()">üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Broadcast</button>
                </div>
            </div>
            
            <div id="broadcastStatusInfo"></div>
        </div>

        <!-- Account Management Section -->
        <div class="account-selector">
            <h3>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ MT5 ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h3>
            
            <!-- Add Account Form -->
            <div id="addAccountForm" class="hidden">
                <h4>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ MT5 ‡πÉ‡∏´‡∏°‡πà</h4>
                <input type="text" id="accountName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ">
                <input type="text" id="accountLogin" placeholder="Login MT5">
                <input type="password" id="accountPassword" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô MT5">
                <input type="text" id="accountServer" placeholder="Server MT5">
                <input type="text" id="accountBroker" placeholder="‡πÇ‡∏ö‡∏£‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå (‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)">
                <select id="accountType">
                    <option value="demo">Demo</option>
                    <option value="real">Real</option>
                </select>
                <div>
                    <button onclick="addAccount()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</button>
                    <button onclick="hideAddAccountForm()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            </div>
            
            <button id="showAddAccountBtn" onclick="showAddAccountForm()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ MT5</button>
            
            <!-- Account List -->
            <div id="accountList"></div>
            
            <!-- Current Connection Status -->
            <div id="connectionStatus" class="hidden">
                <h4>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¢‡∏π‡πà:</h4>
                <div id="currentAccount"></div>
            </div>
        </div>

        <!-- Original Calculator Interface -->
        <div class="container">
            <h1>üèÜ Gold Trading Calculator</h1>
            <p class="subtitle">‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Lot Size ‡πÅ‡∏•‡∏∞ Take Profit ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏î Gold ‡πÅ‡∏ö‡∏ö‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û</p>

            <!-- Portfolio Settings -->
            <div class="section">
                <h2>üìä ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏≠‡∏£‡πå‡∏ï‡πÇ‡∏ü‡∏•‡∏¥‡πÇ‡∏≠</h2>
                <div class="input-group">
                    <label for="portfolioSize">üí∞ ‡∏Ç‡∏ô‡∏≤‡∏î‡∏û‡∏≠‡∏£‡πå‡∏ï‡πÇ‡∏ü‡∏•‡∏¥‡πÇ‡∏≠ (USD):</label>
                    <input type="number" id="portfolioSize" value="1000" min="1" step="1">
                </div>
                <div class="input-group">
                    <label for="riskPercent">‚ö†Ô∏è ‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á (%):</label>
                    <input type="number" id="riskPercent" value="2" min="0.1" max="50" step="0.1">
                </div>
            </div>

            <!-- Entry Orders -->
            <div class="section">
                <h2>üéØ ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (Entry Orders)</h2>
                <div class="input-group">
                    <label for="symbol">üìà Symbol:</label>
                    <select id="symbol">
                        <option value="XAUUSD">XAUUSD (Gold)</option>
                        <option value="XAGUSD">XAGUSD (Silver)</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="entryPrice1">üí≤ Entry Price 1:</label>
                    <input type="number" id="entryPrice1" value="2650.00" step="0.01">
                </div>
                <div class="input-group">
                    <label for="stopLoss">üõë Stop Loss:</label>
                    <input type="number" id="stopLoss" value="2640.00" step="0.01">
                </div>
            </div>

            <!-- Take Profit Management -->
            <div class="section">
                <h2>üéØ Take Profit Management</h2>
                <div class="input-group">
                    <label for="tpCount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô TP:</label>
                    <select id="tpCount" onchange="updateTPFields()">
                        <option value="3">3 TP</option>
                        <option value="5">5 TP</option>
                    </select>
                </div>
                <div id="tpContainer"></div>
            </div>

            <!-- Action Buttons -->
            <div class="section">
                <button onclick="calculateRisk()" class="calc-btn">üßÆ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</button>
                <button onclick="sendToMT5()" class="send-btn" disabled id="sendBtn">üì§ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÑ‡∏õ MT5</button>
                <button onclick="broadcastToMT5()" class="send-btn hidden" id="broadcastBtn">üì° Broadcast ‡πÑ‡∏õ‡∏ó‡∏∏‡∏Å User</button>
            </div>

            <!-- Results -->
            <div id="results" class="results"></div>
        </div>
    </div>

    <script>
        // Global variables
        let authToken = localStorage.getItem('authToken');
        let currentUser = null;
        let userRole = null;
        let accounts = [];
        let currentAccount = null;
        let isBroadcastMode = false;
        
        // API Configuration
        const API_BASE = 'http://localhost:8080/api';  // Change for production
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            if (authToken) {
                validateToken();
            } else {
                showAuthContainer();
            }
            updateTPFields(); // Initialize TP fields
        });
        
        // Authentication Functions
        function showAuthContainer() {
            document.getElementById('authContainer').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }
        
        function showMainApp() {
            document.getElementById('authContainer').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            loadUserAccounts();
        }
        
        function showLoginForm() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            clearAuthMessage();
        }
        
        function showRegisterForm() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
            clearAuthMessage();
        }
        
        function clearAuthMessage() {
            document.getElementById('authMessage').textContent = '';
            document.getElementById('authMessage').className = 'error';
        }
        
        function showAuthMessage(message, isError = true) {
            const messageEl = document.getElementById('authMessage');
            messageEl.textContent = message;
            messageEl.className = isError ? 'error' : 'success';
        }
        
        async function register() {
            const username = document.getElementById('registerUsername').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const role = document.getElementById('registerRole').value;
            
            if (!username || !email || !password) {
                showAuthMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á');
                return;
            }
            
            if (password !== confirmPassword) {
                showAuthMessage('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, password, role })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showAuthMessage(`‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (Role: ${data.role}) ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö`, false);
                    setTimeout(showLoginForm, 2000);
                } else {
                    showAuthMessage(data.error || '‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
                }
            } catch (error) {
                showAuthMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠');
            }
        }
        
        async function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!username || !password) {
                showAuthMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    authToken = data.token;
                    currentUser = { id: data.user_id, username };
                    userRole = data.role;
                    localStorage.setItem('authToken', authToken);
                    showMainApp();
                    updateUserInfo();
                    setupRoleBasedUI();
                } else {
                    showAuthMessage(data.error || '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
                }
            } catch (error) {
                showAuthMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠');
            }
        }
        
        async function validateToken() {
            try {
                const response = await fetch(`${API_BASE}/accounts`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    showMainApp();
                    updateUserInfo();
                } else {
                    localStorage.removeItem('authToken');
                    authToken = null;
                    showAuthContainer();
                }
            } catch (error) {
                localStorage.removeItem('authToken');
                authToken = null;
                showAuthContainer();
            }
        }
        
        function logout() {
            localStorage.removeItem('authToken');
            authToken = null;
            currentUser = null;
            userRole = null;
            currentAccount = null;
            accounts = [];
            isBroadcastMode = false;
            showAuthContainer();
        }
        
        function updateUserInfo() {
            if (currentUser) {
                document.getElementById('userInfo').textContent = `‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ${currentUser.username}`;
                
                // Show role badge
                const roleBadge = document.getElementById('userRoleBadge');
                if (userRole) {
                    roleBadge.classList.remove('hidden');
                    if (userRole === 'super_admin') {
                        roleBadge.className = 'super-admin-badge';
                        roleBadge.textContent = 'üëë Super Admin';
                    } else if (userRole === 'broadcast') {
                        roleBadge.className = 'broadcast-badge';
                        roleBadge.textContent = 'üì° Broadcast User';
                    } else {
                        roleBadge.classList.add('hidden');
                    }
                }
            }
        }
        
        function setupRoleBasedUI() {
            // Show broadcast section only for super_admin
            if (userRole === 'super_admin') {
                document.getElementById('broadcastSection').classList.remove('hidden');
            }
            
            // For broadcast users, show different UI elements if needed
            if (userRole === 'broadcast') {
                // Could add special indicators or limitations
                console.log('User has broadcast role');
            }
        }
        
        // Account Management Functions
        async function loadUserAccounts() {
            try {
                const response = await fetch(`${API_BASE}/accounts`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    accounts = data.accounts;
                    renderAccountList();
                }
            } catch (error) {
                console.error('Failed to load accounts:', error);
            }
        }
        
        function renderAccountList() {
            const container = document.getElementById('accountList');
            
            if (accounts.length === 0) {
                container.innerHTML = '<p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ MT5 ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡∏°‡πà</p>';
                return;
            }
            
            container.innerHTML = accounts.map(account => `
                <div class="account-item ${currentAccount?.id === account.id ? 'active' : ''}" 
                     onclick="selectAccount(${account.id})">
                    <div>
                        <span class="status-indicator ${getAccountStatus(account.id)}"></span>
                        <strong>${account.account_name}</strong><br>
                        <small>Login: ${account.login} | Server: ${account.server}</small>
                    </div>
                    <div>
                        ${currentAccount?.id === account.id ? 
                            '<button onclick="disconnectAccount(event)">‡∏ï‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</button>' : 
                            '<button onclick="connectAccount(event, ' + account.id + ')">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</button>'
                        }
                    </div>
                </div>
            `).join('');
        }
        
        function getAccountStatus(accountId) {
            if (currentAccount?.id === accountId) {
                return 'status-connected';
            }
            return 'status-disconnected';
        }
        
        function showAddAccountForm() {
            document.getElementById('addAccountForm').classList.remove('hidden');
            document.getElementById('showAddAccountBtn').classList.add('hidden');
        }
        
        function hideAddAccountForm() {
            document.getElementById('addAccountForm').classList.add('hidden');
            document.getElementById('showAddAccountBtn').classList.remove('hidden');
        }
        
        async function addAccount() {
            const accountData = {
                account_name: document.getElementById('accountName').value,
                login: document.getElementById('accountLogin').value,
                password: document.getElementById('accountPassword').value,
                server: document.getElementById('accountServer').value,
                broker: document.getElementById('accountBroker').value,
                account_type: document.getElementById('accountType').value
            };
            
            if (!accountData.account_name || !accountData.login || !accountData.password || !accountData.server) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/accounts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(accountData)
                });
                
                if (response.ok) {
                    hideAddAccountForm();
                    // Clear form
                    ['accountName', 'accountLogin', 'accountPassword', 'accountServer', 'accountBroker'].forEach(id => {
                        document.getElementById(id).value = '';
                    });
                    loadUserAccounts();
                } else {
                    const data = await response.json();
                    alert(data.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÑ‡∏î‡πâ');
                }
            } catch (error) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠');
            }
        }
        
        function selectAccount(accountId) {
            // This just highlights the account, doesn't connect
            const account = accounts.find(a => a.id === accountId);
            if (account) {
                console.log('Selected account:', account.account_name);
            }
        }
        
        async function connectAccount(event, accountId) {
            event.stopPropagation();
            
            try {
                const response = await fetch(`${API_BASE}/accounts/${accountId}/connect`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    authToken = data.token; // Update token with account context
                    localStorage.setItem('authToken', authToken);
                    currentAccount = accounts.find(a => a.id === accountId);
                    renderAccountList();
                    updateConnectionStatus();
                    enableSendButton();
                } else {
                    const data = await response.json();
                    alert(data.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÑ‡∏î‡πâ');
                }
            } catch (error) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠');
            }
        }
        
        function disconnectAccount(event) {
            event.stopPropagation();
            currentAccount = null;
            renderAccountList();
            updateConnectionStatus();
            disableSendButton();
        }
        
        function updateConnectionStatus() {
            const statusDiv = document.getElementById('connectionStatus');
            const currentAccountDiv = document.getElementById('currentAccount');
            
            if (currentAccount) {
                statusDiv.classList.remove('hidden');
                currentAccountDiv.innerHTML = `
                    <span class="status-indicator status-connected"></span>
                    <strong>${currentAccount.account_name}</strong> (${currentAccount.login})
                `;
            } else {
                statusDiv.classList.add('hidden');
            }
        }
        
        function enableSendButton() {
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = false;
            sendBtn.textContent = 'üì§ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÑ‡∏õ MT5';
            
            // Show/hide broadcast button based on mode and role
            updateBroadcastButton();
        }
        
        function disableSendButton() {
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.textContent = 'üì§ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á';
            
            // Hide broadcast button
            document.getElementById('broadcastBtn').classList.add('hidden');
        }
        
        function updateBroadcastButton() {
            const broadcastBtn = document.getElementById('broadcastBtn');
            
            if (userRole === 'super_admin' && isBroadcastMode) {
                broadcastBtn.classList.remove('hidden');
            } else {
                broadcastBtn.classList.add('hidden');
            }
        }
        
        // Broadcast Mode Functions
        function toggleBroadcastMode() {
            isBroadcastMode = document.getElementById('broadcastMode').checked;
            const broadcastInfo = document.getElementById('broadcastInfo');
            
            if (isBroadcastMode) {
                broadcastInfo.classList.remove('hidden');
            } else {
                broadcastInfo.classList.add('hidden');
            }
            
            updateBroadcastButton();
        }
        
        async function checkBroadcastStatus() {
            if (userRole !== 'super_admin') {
                alert('‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Super Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Broadcast ‡πÑ‡∏î‡πâ');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/broadcast_status`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayBroadcastStatus(data);
                } else {
                    const error = await response.json();
                    alert(error.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Broadcast ‡πÑ‡∏î‡πâ');
                }
            } catch (error) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠');
            }
        }
        
        function displayBroadcastStatus(data) {
            const statusDiv = document.getElementById('broadcastStatusInfo');
            
            let html = '<h4>üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Broadcast ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)</h4>';
            
            if (data.broadcast_statistics && data.broadcast_statistics.length > 0) {
                html += '<div style="margin: 10px 0;"><strong>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á:</strong><ul>';
                data.broadcast_statistics.forEach(stat => {
                    html += `<li>${stat.status}: ${stat.count} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${new Date(stat.latest).toLocaleString('th-TH')})</li>`;
                });
                html += '</ul></div>';
            }
            
            if (data.broadcast_users && data.broadcast_users.length > 0) {
                html += '<div style="margin: 10px 0;"><strong>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ Broadcast ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö:</strong><ul>';
                data.broadcast_users.forEach(user => {
                    const lastLogin = user.last_login ? new Date(user.last_login).toLocaleString('th-TH') : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢ login';
                    const status = user.is_active ? 'üü¢ ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : 'üî¥ ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
                    html += `<li>${user.username} - ${status} (Login ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${lastLogin})</li>`;
                });
                html += '</ul></div>';
            } else {
                html += '<p>‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ Broadcast ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>';
            }
            
            statusDiv.innerHTML = html;
        }
        
        // Original Calculator Functions (modified for API)
        function updateTPFields() {
            const count = parseInt(document.getElementById('tpCount').value);
            const container = document.getElementById('tpContainer');
            
            const percentages = {
                3: [50, 30, 20],
                5: [40, 20, 20, 10, 10]
            };
            
            let html = '';
            for (let i = 1; i <= count; i++) {
                html += `
                    <div class="tp-group">
                        <label for="tp${i}">Take Profit ${i} (${percentages[count][i-1]}%):</label>
                        <input type="number" id="tp${i}" step="0.01">
                        <span class="tp-percentage">${percentages[count][i-1]}%</span>
                    </div>
                `;
            }
            container.innerHTML = html;
        }
        
        async function calculateRisk() {
            if (!currentAccount) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ MT5 ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì');
                return;
            }
            
            const data = {
                symbol: document.getElementById('symbol').value,
                entryPrice1: document.getElementById('entryPrice1').value,
                stopLoss: document.getElementById('stopLoss').value,
                portfolioSize: document.getElementById('portfolioSize').value,
                riskPercent: document.getElementById('riskPercent').value
            };
            
            try {
                const response = await fetch(`${API_BASE}/calculate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    displayResults(result);
                } else {
                    const error = await response.json();
                    alert(error.error || '‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
                }
            } catch (error) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠');
            }
        }
        
        function displayResults(result) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <h3>üìä ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</h3>
                <div class="result-item">
                    <span class="label">Symbol:</span>
                    <span class="value">${result.symbol}</span>
                </div>
                <div class="result-item">
                    <span class="label">Lot Size:</span>
                    <span class="value highlight">${result.lotSize}</span>
                </div>
                <div class="result-item">
                    <span class="label">Risk Amount:</span>
                    <span class="value">$${result.riskAmount.toFixed(2)}</span>
                </div>
                <div class="result-item">
                    <span class="label">Stop Distance:</span>
                    <span class="value">${result.stopDistance.toFixed(2)} points</span>
                </div>
                <p class="calculation-time">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date(result.calculatedAt).toLocaleString('th-TH')}</p>
            `;
        }
        
        async function sendToMT5() {
            if (!currentAccount && !isBroadcastMode) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ MT5 ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á');
                return;
            }
            
            // Collect all form data
            const orderData = {
                symbol: document.getElementById('symbol').value,
                entryPrice1: document.getElementById('entryPrice1').value,
                stopLoss: document.getElementById('stopLoss').value,
                portfolioSize: document.getElementById('portfolioSize').value,
                riskPercent: document.getElementById('riskPercent').value
            };
            
            // Add TP levels
            const tpCount = parseInt(document.getElementById('tpCount').value);
            for (let i = 1; i <= tpCount; i++) {
                const tpValue = document.getElementById(`tp${i}`).value;
                if (tpValue) {
                    orderData[`tp${i}`] = tpValue;
                }
            }
            
            try {
                const response = await fetch(`${API_BASE}/send_orders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(orderData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert('‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÑ‡∏õ MT5 ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                } else {
                    const error = await response.json();
                    alert(error.error || '‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
                }
            } catch (error) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠');
            }
        }
        
        async function broadcastToMT5() {
            if (userRole !== 'super_admin') {
                alert('‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Super Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ Broadcast ‡πÑ‡∏î‡πâ');
                return;
            }
            
            if (!isBroadcastMode) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Broadcast Mode ‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }
            
            // Confirm broadcast action
            const confirmResult = confirm(
                'üö® ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏™‡πà‡∏á Broadcast Order ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ role "broadcast"\n\n' +
                '‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏ó‡∏≥ order ‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ\n\n' +
                '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠?'
            );
            
            if (!confirmResult) {
                return;
            }
            
            // Collect all form data
            const orderData = {
                symbol: document.getElementById('symbol').value,
                entryPrice1: document.getElementById('entryPrice1').value,
                stopLoss: document.getElementById('stopLoss').value,
                portfolioSize: document.getElementById('portfolioSize').value,
                riskPercent: document.getElementById('riskPercent').value
            };
            
            // Add TP levels
            const tpCount = parseInt(document.getElementById('tpCount').value);
            for (let i = 1; i <= tpCount; i++) {
                const tpValue = document.getElementById(`tp${i}`).value;
                if (tpValue) {
                    orderData[`tp${i}`] = tpValue;
                }
            }
            
            try {
                const response = await fetch(`${API_BASE}/broadcast_orders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(orderData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(
                        `üì° Broadcast Order ‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n\n` +
                        `üéØ ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á: ${result.target_users} ‡∏Ñ‡∏ô\n` +
                        `‚úÖ ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${result.executed_successfully} ‡∏Ñ‡∏ô\n` +
                        `‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤: ${new Date(result.timestamp).toLocaleString('th-TH')}`
                    );
                    
                    // Auto refresh broadcast status
                    setTimeout(checkBroadcastStatus, 1000);
                } else {
                    const error = await response.json();
                    alert(error.error || '‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á Broadcast ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
                }
            } catch (error) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠');
            }
        }
    </script>
</body>
</html>
